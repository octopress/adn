/*!
App.net timeline fetcher (c) 2013 Brandon Mathis, @imathis // MIT License
Version: 1.2
Source: https://github.com/imathis/adn-timeline/
*/
(function(){var e,t,n=[].slice;e={defaults:{el:".adn-timeline",count:4,replies:!1,reposts:!1,cookie:"adn-timeline",avatars:!1},init:function(e){var t,n,r,i=this;e==null&&(e=[{}]),e instanceof Array||(e=[e]);for(n=0,r=e.length;n<r;n++)t=e[n],$(t.el||this.defaults.el).each(function(e,n){var r,s,o,u;return n=$(n),s=t.render||i.render,r=t.callback||function(){},t=$.extend({},i.defaults,t,n.data()),t.el=n,t.username=(o=t.username)!=null?o.replace("@",""):void 0,t.hashtag=(u=t.hashtag)!=null?u.replace("#",""):void 0,t.username==null&&t.hashtag==null?console.error("You need to provide an App.net username or hashtag"):(t.cookie===i.defaults.cookie&&(t.cookie=t.cookie+("-"+(t.username||t.hashtag))),i.timeline(i.helpers).fetch(s,r,t))});return this},cascadeOptions:function(){var e,t,r,i;t=1<=arguments.length?n.call(arguments,0):[];for(r=0,i=t.length;r<i;r++){e=t[r];if(e!=null&&e===e)return e}},render:function(e,t){var n,r,i,s,o;n=e.el,i="<ul id='adn-timeline-"+(e.username||e.hashtag)+"'>";for(s=0,o=t.length;s<o;s++)r=t[s],i+="<li><figure class='adn-post'>",r.author.avatar&&(i+="<a href='"+r.author.url+"' class='adn-author-avatar-link'>",r.author.avatar&&(i+="<img alt='@"+r.author.username+"'s avatar on App.net' class='adn-author-avatar' width=48 src='"+r.author.avatar+"'>"),i+="</a>"),i+="<figcaption>",r.author.unique&&(i+="<p>",r.repost&&(i+="<span class='adn-repost-marker'>>></span> "),i+="<a href='"+r.author.url+"' class='adn-author-url' rel=author>",i+="<strong class='adn-author-name'>"+r.author.name+"</strong> <span class='adn-author-username'>@"+r.author.username+"</span>",i+="</a></p>"),i+="<a href='"+r.url+"' class='adn-post-url'><time datetime='"+r.date+"'>"+r.display_date+"</time></a>",i+="</figcaption>",i+="<blockquote><p>",i+=r.text,i+="</p></blockquote>",i+="</figure></li>";return i+="</ul>",n.append(i)},timeline:function(e){return{data:[],fetch:function(t,n,r){var i,s,o,u=this;return $.cookie&&r.cookie&&(s=$.cookie(r.cookie))?(i=JSON.parse(s),i.length!==r.count?($.removeCookie(r.cookie),this.fetch(t,n,r)):(t(r,i),n(i))):(o="https://alpha-api.app.net/stream/0/",r.username&&(o+="users/@"+r.username+"/posts?include_deleted=0"),r.hashtag&&(o+="posts/tag/"+r.hashtag+"?include_deleted=0"),r.before_id&&(o+="&before_id="+r.before_id),r.replies||(o+="&include_directed_posts=0"),o+="&callback=?",$.ajax({url:o,dataType:"jsonp",error:function(e){return console.error("Error fetching App.net timeline"),console.error(e)},success:function(s){var o,a,f,l;if(!r.reposts){i=[],l=s.data;for(a=0,f=l.length;a<f;a++)o=l[a],o.repost_of||i.push(o);s.data=i}return u.data=u.data.concat(s.data),u.data.length<r.count?(r.before_id=s.meta.min_id,u.fetch(t,n,r)):(u.data=function(){var t,n,i,s;i=this.data.slice(0,r.count),s=[];for(t=0,n=i.length;t<n;t++)o=i[t],s.push(e.postData(o,r));return s}.call(u),$.cookie&&r.cookie&&$.cookie(r.cookie,JSON.stringify(u.data,{path:"/"})),t(r,u.data),n(u.data))}}))}}},helpers:{trimUrl:function(e){var t,n,r,i,s,o,u;r=[],t=40,e=e.replace(/(https?:\/\/)/i,""),u=e.split("/");for(s=0,o=u.length;s<o;s++){n=u[s];if(!(r.concat(n).join("/").length<t))break;r.push(n)}return i=r.join("/"),e.length-i.length>15&&(i=e.slice(0,t)),i.length<e.length?i+"&hellip;":i},trimDisplayUrls:function(e){var t=this;return e.replace(/>\s*(https?:\/\/.+?)\s*</gi,function(e,n){return">"+t.trimUrl(n)+"<"})},linkify:function(e){var t,n,r,i,s,o,u,a,f;r=this.trimDisplayUrls(e.html),a=e.entities.mentions;for(i=0,o=a.length;i<o;i++)n=a[i],r=r.replace(new RegExp("@("+n.name+")","gi"),"<a class='adn-username' href='https://alpha.app.net/$1'>@$1</a>");f=e.entities.hashtags;for(s=0,u=f.length;s<u;s++)t=f[s],r=r.replace(new RegExp("#("+t.name+")","gi"),"<a class='adn-hashtag' href='https://alpha.app.net/hashtags/$1'>#$1</a>");return r},postData:function(e,t){var n,r;return r=!!e.repost_of,r&&(e=e.repost_of),t.avatars&&(n=e.user.avatar_image.url),{repost:r,url:e.canonical_url,date:e.created_at,display_date:this.timeago(e.created_at),author:{username:e.user.username,name:e.user.name,url:e.user.canonical_url,avatar:n,unique:!!t.reposts||!!t.hashtag},text:this.linkify(e)}},timeago:function(e){var t,n,r,i,s,o;return i={just_now:"now",minute_ago:"1m",minutes_ago:"m",hour_ago:"1h",hours_ago:"h",yesterday:"1d",days_ago:"d",last_week:"1w",weeks_ago:"w"},s=((new Date).getTime()-(new Date(e)).getTime())/1e3,r=Math.floor(s/60),n=Math.floor(s/3600),t=Math.floor(s/86400),o=Math.floor(t/7),isNaN(s)||t<0?"#":t===0?s<60?i.just_now:s<120?i.minute_ago:s<3600?r+i.minutes_ago:s<7200?i.hour_ago:n+i.hours_ago:t===1?i.yesterday:t<7?t+i.days_ago:t===7?i.last_week:o+i.weeks_ago}}},typeof t!="undefined"&&t!==null?typeof module!="undefined"&&module!==null&&module.exports?t=module.exports=e:t.AdnTimeline=e:this.AdnTimeline=e}).call(this);